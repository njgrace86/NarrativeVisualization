<!Doctype html>

<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Narrative Vis</title>

    </head>
    <body onload='init()'>
    <h1>Chart</h1>
        <!--import d3 -->
        <script src="//d3js.org/d3.v7.min.js"></script>

        

        <!-- Add buttons -->
        <button onclick="changeState(0)">Age Data Only</button>
        <button onclick="changeState(1)">Experience by Age</button>
        <button onclick="changeState(2)">Session Length by Age</button>

        <!--div for visualization-->
        <div id="narrative_viz"></div>

        <!--specify visualization-->
        <script>

            var page_state = 0;

            // Set margins
            var margin = {top: 50, bottom: 100, left: 100, right: 50};

            // Set canvas dimensions
            var width = 1000 - margin.left - margin.right;
            var height = 1000 - margin.top - margin.bottom; 

            // Import data
            async function init(){
                const age_data = await d3.csv("/CrochetAge.csv");
                const exp_data = await d3.csv("/CrochetAgebyExp.csv", d3.autoType);
                const ses_data = await d3.csv("/CrochetAgebySession.csv", d3.autoType);

                // Format data grouping by age, age/experience, age/session
                // const age_label = (d3.permute(Array.from(d3.group(data, (d) => d.Age).keys()), [1,3,2,4,5,0,6]));
                // const exp_label = (d3.permute(Array.from(d3.group(data, (d) => d.YearExperience).keys()), [2,1,5,4,0,3]));
                // const time_lable = (d3.permute(Array.from(d3.group(data, (d) => d.SessionTime).keys()), [3,0,2,1]));

                // const age_range = d3.rollup(data, (D) => D.length, (d) => d.Age);
                // const age_exp = d3.rollup(data, (D) => D.length, (d) => d.Age, (d) => d.YearExperience);
                // const age_time = d3.rollup(data, (D) => D.length, (d) => d.Age, (d) => d.SessionTime);

                // console.log(age_range.keys())

                // var max_age_count = Math.max(...Array.from(age_range.values()))
        
                // // Define svg
                // var svg = d3.select("#narrative_viz")
                //     .append("svg")
                //         .attr("width", width + margin.left + margin.right)
                //         .attr("height", height + margin.top + margin.bottom)
                //     .append("g")
                //         .attr("transform", "translate(" + margin.left + "," + margin.top + ")");    
                        
                // console.log(exp_data)      
                
                y_max = Math.ceil(Math.max(...age_data.map(function (d) {return +d.Count}))/50)*50

                // var x_values = [...age_range.keys()]
                // var y_values = [...age_range.values()]
                // console.log(y_values)

                // Define X axis
                // var x = d3.scaleBand()
                //     .domain(x_values)
                //     .range([0, width])

                // svg.append("g")
                //     .attr("transform", "translate(0," + height + ")")
                //     .call(d3.axisBottom(x));


                // //http://www.d3noob.org/2012/12/adding-axis-labels-to-d3js-graph.html       
                // svg.append("text")
                //     .attr("transform", "translate(" + (width / 2) + " ," + (height + margin.bottom) + ")")
                //     .style("text-anchor", "middle")
                //     .text("Age Band");                


                // // Define Y axis
                // var y = d3.scaleLinear()
                //     .domain([0, Math.ceil(max_age_count/50) * 50])
                //     .range([height, 0]);

                // svg.append("g")
                //     .call(d3.axisLeft(y)); 

                // //http://www.d3noob.org/2012/12/adding-axis-labels-to-d3js-graph.html    
                // svg.append("text")
                //     .attr("transform", "rotate(-90)")
                //     .attr("y", 0 - margin.left)
                //     .attr("x", 0 - (height / 2))
                //     .attr("dy", "1em")
                //     .style("text-anchor", "middle")
                //     .text("Count");           
                    
                // // Define fill colors
                // var fill_color = d3.scaleOrdinal()
                //     .domain(age_label)
                //     .range(['#e41a1c','#377eb8','#4daf4a'])

                // // Initial bar graph
                // svg.selectAll("rect")
                //     .data(age_range.values())
                //     .enter()
                //     .append("rect")
                //         .attr("x", function (d, i) {return x.bandwidth() * i})
                //         .attr("y", function (d) {return y(d)})
                //         .attr("width", x.bandwidth())
                //         .attr("height", function (d) {return (height - y(d))})
                //         .attr("fill", "steelblue")

                // // Define X axis
                // var x = d3.scaleBand()
                //     .domain(age_data.map(function (d) {return d.Age}))
                //     .range([0, width])
                //     .padding([0.2])

                // svg.append("g")
                //     .attr("transform", "translate(0," + height + ")")
                //     .call(d3.axisBottom(x));


                // //http://www.d3noob.org/2012/12/adding-axis-labels-to-d3js-graph.html       
                // svg.append("text")
                //     .attr("transform", "translate(" + (width / 2) + " ," + (height + margin.bottom / 2) + ")")
                //     .style("text-anchor", "middle")
                //     .text("Age Band");                


                // // Define Y axis
                // var y = d3.scaleLinear()
                //     .domain([0, y_max])
                //     .range([height, 0]);

                // svg.append("g")
                //     .call(d3.axisLeft(y)); 

                // //http://www.d3noob.org/2012/12/adding-axis-labels-to-d3js-graph.html    
                // svg.append("text")
                //     .attr("transform", "rotate(-90)")
                //     .attr("y", 0 - margin.left)
                //     .attr("x", 0 - (height / 2))
                //     .attr("dy", "1em")
                //     .style("text-anchor", "middle")
                //     .text("Count");           
                    
                // // Define fill colors
                // var fill_color = d3.scaleOrdinal()
                //     .domain(age_label)
                //     .range(['#e41a1c','#377eb8','#4daf4a'])

                // // Initial bar graph
                // svg.selectAll("rect")
                //     .data(age_data)
                //     .enter()
                //     .append("rect")
                //         .attr("x", function (d, i) {return x.bandwidth() * i})
                //         .attr("y", function (d) {return y(d.Count)})
                //         .attr("width", x.bandwidth())
                //         .attr("height", function(d) {return (height - y(d.Count))})
                //         .attr("fill", "steelblue")  
                
                //https://d3-graph-gallery.com/graph/barplot_stacked_basicWide.html
                // Stack Exp

                // Get exp levels
                var exp_level = exp_data.columns.slice(1)
                console.log(exp_level)

                // Get exp data grouped by age range
                // var exp_ages = d3.map(exp_data, function (d){return(d.Age)}).keys()
                var exp_ages = exp_data.map(function (d) {return d.Age})


                // Stack by exp level
                var exp_stacked = d3.stack()
                    .keys(exp_level)
                    (exp_data)

                console.log(exp_stacked)           
                
                // Define exp svg1
                var svg1 = d3.select("#narrative_viz")
                    .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");   
                        
                // Define exp X axis
                var x1 = d3.scaleBand()
                    .domain(exp_ages)
                    .range([0, width])
                    .padding([0.2])

                svg1.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x1));


                //http://www.d3noob.org/2012/12/adding-axis-labels-to-d3js-graph.html       
                svg1.append("text")
                    .attr("transform", "translate(" + (width / 2) + " ," + (height + margin.bottom / 2) + ")")
                    .style("text-anchor", "middle")
                    .text("Age Band");                


                // Define exp Y axis
                var y1 = d3.scaleLinear()
                    .domain([0, y_max])
                    .range([height, 0]);

                svg1.append("g")
                    .call(d3.axisLeft(y1)); 

                //http://www.d3noob.org/2012/12/adding-axis-labels-to-d3js-graph.html    
                svg1.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0 - margin.left)
                    .attr("x", 0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text("Count");           
                    
                // Define fill colors
                var fill_color = d3.scaleOrdinal()
                    .domain(exp_level)
                    .range(["#f0f9e8","#ccebc5","#a8ddb5","#7bccc4","#43a2ca","#0868ac"])                

                // Add stacked bars
                svg1.append("g")
                    .selectAll("g")
                    .data(exp_stacked)
                    .enter()
                    .append("g")
                        .attr("fill", function (d) {return fill_color(d.key)})
                        .selectAll("rect")
                        .data(function (d) {return d})
                        .enter()
                        .append("rect")
                            .attr("x", function (d) {return x1(d.data.Age)})
                            .attr("y", function (d) {return y1(d[1])})
                            .attr("width", x1.bandwidth())
                            .attr("height", function (d) { return y1(d[0]) - y1(d[1])})
                            

                
                    


                }
        </script>
    </body>
</html>